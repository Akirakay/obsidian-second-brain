事件发生的背景

解决了什么问题

我做了什么

1、小站数据的接入和转换，包括：雷达即时数据、过车数据、排队数据、卡口数据

2、信号数据的接入和转换

3、信号方案接入

4、实时事件接入

5、文件定时清理

6、轨迹回放

7、上虞二十路口

各位面试官，你们好，我叫黄凯强，毕业于南阳理工学院软件工程专业，到现在为止已经工作五年了，之前就职于浙江中控信息产业股份有限公司智慧交通研发部，从事自研产品全息路口的开发，此款产品以路口雷达设备和视频监控设备产生的数据为基础，通过雷视拟合技术对车辆、行人、非机动车全息3d投影，使用的技术栈是

这款产品是基于我们公司自研雷达、信号机以及视频监控的数据通过计算和清洗近乎实时的以2.5d模型在页面全息投影展示出来，比如路口跑的机动车、非机动车和行人都能在页面上以模型方式动态映照出来。

接下来我说一下我们这个产品的技术架构，后端使用的开发框架是springboot、springcloud和mybatisplus，第三方组件有kafka、redis，搜索引擎是es，数据库是mysql，定时任务框架是xxl-job，部署平台和工具是k8s和docker。

其次我说一下我们的数据流转，通过websocket把数据从小站接入到数据中台，然后把数据清洗一下再推回到数据中台，然后算法服务会去消费这些数据吐出融合再到数据中台，最后我们的业务服务会把融合数据输出到前端，前端页面就有了车辆模型在跑，整个过程其实就是一个etl。

然后我说一下我主要做的内容，第一个是小站数据的接入。小站就是用来收集路口安装设备的数据，比如雷达、卡口的数据，我这边通过websocket去订阅小站的数据，通过传不同的参数来获取不同类型的数据，拿到这些数据后会放到数据中台。这个数据的接入要考虑个问题，比如断线了怎么办，我当时的做法是通过我这边代码去监听websocket数据传输间隔时长，如果超过5分钟还没数据产生那将触发重连机制，以此来保证通道是畅通的。

第二个，数据的清洗和转换，把数据接入到数据中台后，需要对它进行清洗和转换，通过监听kafka的topic把源数据拿出来，主要做和路口的一些关联赋值。关联赋值的时候需要调用feign查出基础信息的内容，我们的数据量特别大，一台雷达十几毫秒产生一条数据，一个路口平均四个雷达，考虑到这个数据产生速度直接rpc调用服务一定会把服务掉崩的，为了保证服务的稳定性和提高实时性后面我写了一个基础信息缓存类，通过服务初始化的时候把数据查询起来放到map里面，然后通过监听最后更新时间来保证数据的实时性，不过没放到redis里面而是放到了服务里面，主要是考虑到每次请求redis可能也会浪费一点时间。因为我们的这个产品对数据实时性要求很高，整体的延迟要在五秒以内。在转换的过程中还要把一些指标数据存放到es中，比如流量、速度之类的，提供后续业务服务使用，这里采用的存储方式是异步，主要还是为了减少数据延迟，像这些数据存放es的时候为了防止查询过慢，我做了一个索引存放规则，按天去存储索引。

3、信号方案的接入。通过websocket订阅信号平台的数据，根据他们提供的规则进行组装信号倒计时，不但做到路口倒计时还做到了车道级倒计时。

4、实时事件接入。打通集成平台和视觉检测平台，通过暴露出来的api，接入实时事件，包括事件的照片和视频，前端通过websocket和http协议来获取实时事件和历史事件。

5、轨迹回放。这个主要是满足查看事件时，需要查看车辆轨迹。我们当时是把融合数据按天放到es里面存储了起来，需要查询时根据时间段查询即可。但是这里面有几个难点，一就是你查出来了这么多数据如何存放，如果一次性查出来这么多数据内存肯定放不下？二如何推给前端？按什么频率推送？，第一个问题我的解决方式是使用阻塞队列和时长限制，先通过es的滚动查询把数据塞到阻塞队列里面，如果数据量超过了阻塞队列的最大值，将阻塞，直到有空闲位置出来，以及通过限制查询时间段，把数据量尽量平衡到最优点，这样就解决了内存限制问题，第二个问题则是通过websocket把轨迹数据推给前端，经测试验证推送频率5毫秒效果比较好。

痛点和难点：消息队列选型：redis和kafka；路口数据量变大了怎么办，小站数据接入，数据类型太多太杂怎么解决

6、最后面我再说一下我们产品在实施的过程中遇到的最大的难点，有一个地方的路口数超过了八个，达到了二十个，我们的服务支持的路口数是十个以内，这导致的问题是数据延迟非常严重，页面基本看不到车辆。当时转换服务所在的服务器CPU占用率高达120%，当时想的第一个办法是加资源因为那台服务器的资源确实不是很大，加了资源之后刚开始还好，后面cpu又爆红了，我当时就想这个转换服务不能单机了，必须要负载均衡，但是又因为我们当时写的时候是不支持简单的负载均衡的，必须要改代码，因为当时topic是在代码中写死的，为了当时项目要验收的紧急情况，我先是修改了代码然后在k8s里面分别创建了四个接入服务和四个转换服务，把二十个路口拆分成五对一，完成后延迟降到了个位数毫秒级。后续我对接入服务和装换服务进行了优化，可做到无需修改代码只需修改配置文件就可做到负载均衡功能。