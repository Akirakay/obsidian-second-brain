## 引入

对于常规的`hash(obj) % n`算法，如果n有变化，则会导致计算的偏离，致使数据无法找回等。

## 简介

判断hash算法好坏的定义：
- 平衡性：hash结果尽可能分散，充分利用所有缓冲空间
- 单调性：哈希的结果应能够保证原有已分配的内容可以被映射到原有的或者新的缓冲中去
- 分散性：分布式环境中，终端有可能只能看到部分缓冲空间，从而导致相同结果被映射到不同缓冲中去
- 负载：对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容

## 算法介绍

 ### Hash环
 
 key值哈希之后的结果顺时针找上述环形hash空间中，距离自己最近的机器节点，然后将数据存储到上面
![hash-ring](https://pdai.tech/images/alg/alg-dist-hash-4.jpg)

### 删除节点

删除节点会将之前存储在此节点的数据重新存储到下一临近节点，其他键不受影响。
避免了 `hash(obj) % n` 缓存雪崩的问题

![hash-ring-del-node](https://pdai.tech/images/alg/alg-dist-hash-5.jpg)

### 增加节点

与删除节点类似

### 不平衡问题

- 由于删除节点数量导致的某一节点存储数据陡增，从而导致节点**存储和流量**过大而宕机
- 单节点的宕机从而引发集群风暴，雪崩出现

### 虚拟节点

实际节点在hash环中的副本`replica`，打乱顺序分散在整个hash空间

通过将虚拟节点打乱分散在hash环上，可以将宕机的节点的数据分散到其他节点上，从而有效避免单机宕机，引起的其他单机存储和流量飙升问题

![hash-ring-vnode](https://pdai.tech/images/alg/alg-dist-hash-9.png)
